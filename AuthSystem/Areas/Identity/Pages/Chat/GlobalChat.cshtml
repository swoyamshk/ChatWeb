@page
@model GlobalChatModel
@{
    ViewData["Title"] = "Global Chat";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<link rel="stylesheet" href="~/css/chat/userChat.css" />

<div class="container chat-container">
    <h2>Global Chat</h2>

    <div class="chat-buttons">
        <a class="btn btn-success" asp-area="Identity" asp-page="/Chat/CreateChatRoom">Create Chat Room</a>
        <a class="btn btn-success" asp-area="Identity" asp-page="/Chat/ChatRooms">View Chat Rooms</a>
    </div>

    <div class="chat-content-container">
        <div class="chat-content">
            <div class="chat-box" id="chatBox">
                <ul id="messagesList" class="list-group">
                    @foreach (var message in Model.Messages)
                    {
                        <li class="list-group-item @(message.UserName == User.Identity.Name ? "sent" : "received")">
                            @if (message.UserName != User.Identity.Name)
                            {
                                <div class="username">@message.UserName</div>
                            }
                            @if (!string.IsNullOrEmpty(message.Text))
                            {
                                <div class="message">@message.Text</div>
                            }
                            @if (!string.IsNullOrEmpty(message.ImageUrl))
                            {
                                <div class="message"><img src="@message.ImageUrl" class="chat-image" /></div>
                            }
                            <div class="time">@message.Timestamp.ToLocalTime().ToString("HH:mm:ss")</div>
                        </li>
                    }
                </ul>
            </div>

            <div class="chat-input">
                <form id="messageForm" method="post" enctype="multipart/form-data" action="/Identity/Chat/GlobalChat">
                    <input type="hidden" id="userEmail" name="UserEmail" value="@User.Identity.Name" />
                    <input type="text" class="form-control" name="Content" placeholder="Type your message..." />
                    <input type="file" class="form-control" name="Image" accept="image/*" />
                    <button type="submit" class="btn btn-primary" id="sendButton">Send Message</button>
                </form>

            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/3.1.3/signalr.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>

    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .build();

        connection.start().then(function () {
            console.log("SignalR connection established.");
        }).catch(function (err) {
            console.error("Error starting connection: ", err.toString());
        });

        connection.on("ReceiveMessage", function (userName, message, imageUrl) {
            const msgDiv = document.createElement("li");
            msgDiv.classList.add("list-group-item", userName === document.getElementById("userEmail").value ? "sent" : "received");

            let messageContent = '';

            if (userName !== document.getElementById("userEmail").value) {
                messageContent += `<div class="username">${userName}</div>`;
            }

            if (message) {
                messageContent += `<div class="message">${message}</div>`;
            }

            if (imageUrl) {
                messageContent += `<div class="message"><img src="${imageUrl}" class="chat-image" /></div>`;
            }

            messageContent += `<div class="time">${new Date().toLocaleTimeString()}</div>`;

            msgDiv.innerHTML = messageContent;
            document.getElementById("messagesList").appendChild(msgDiv);
            scrollToBottom();
        });

        document.getElementById("messageForm").addEventListener("submit", function (event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);

            // Log FormData contents to the console for debugging
            for (const [key, value] of formData.entries()) {
                console.log(`${key}: ${value}`);
            }

            fetch(form.action, {
                method: "POST",
                body: formData
            }).then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text);
                    });
                }
                return response.json(); // or response.text() if not returning JSON
            }).then(data => {
                console.log("Form submission successful", data);
                const userEmail = document.getElementById("userEmail").value;
                const imageUrl = form.Image.files.length > 0 ? URL.createObjectURL(form.Image.files[0]) : null;

                connection.invoke("SendMessage", userEmail, form.Content.value, imageUrl)
                    .catch(function (err) {
                        console.error("Error sending message: ", err.toString());
                    });

                form.Content.value = '';
                form.Image.value = '';
                scrollToBottom();
            }).catch(error => {
                console.error("Error submitting form:", error.message);
                alert(`Form submission failed: ${error.message}`);
            });
        });



        function scrollToBottom() {
            const chatBox = document.querySelector(".chat-box");
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        window.onload = function () {
            scrollToBottom();
        };
    </script>
}
